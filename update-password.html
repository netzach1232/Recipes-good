<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>איפוס סיסמה</title>
    <link rel="stylesheet" href="style6.css">
</head>

<body>

    <h2>איפוס סיסמה</h2>
    <p>אנא הזן סיסמה חדשה</p>

    <input type="password" id="newPassword" placeholder="סיסמה חדשה" />
    <br />
    <button id="confirmReset">עדכן סיסמה</button>

    <div id="message" class="message"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient(
            'https://izpbbjhikbbbyahxzhkg.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cGJiamhpa2JiYnlhaHh6aGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTMxMDUsImV4cCI6MjA2Mzc2OTEwNX0.Gv0WaUlkUAW1qBNEaaXDCWWpwWgbvBTya8KQzFhx08s'
        );

        const message = document.getElementById("message");
        const button = document.getElementById("confirmReset");

        // שלב 1 – חילוץ access_token מה-URL
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.replace("#", ""));
        const access_token = params.get("access_token");

        if (!access_token) {
            message.textContent = "קישור לא תקין. נסה שוב דרך המייל.";
            message.style.color = "red";
        } else {
            // שלב 2 – התחברות עם הטוקן
            const { data, error } = await supabase.auth.setSession({ access_token, refresh_token: params.get("refresh_token") });

            if (error) {
                message.textContent = "שגיאה בהתחברות: " + error.message;
                message.style.color = "red";
            } else {
                // שלב 3 – איפוס סיסמה
                button.addEventListener("click", async () => {
                    const newPassword = document.getElementById("newPassword").value.trim();

                    if (!newPassword || newPassword.length < 8) {
                        message.textContent = "הסיסמה חייבת להכיל לפחות 8 תווים.";
                        message.style.color = "red";
                        return;
                    }

                    const { error } = await supabase.auth.updateUser({ password: newPassword });

                    if (error) {
                        message.textContent = "שגיאה: " + error.message;
                        message.style.color = "red";
                    } else {
                        message.textContent = "הסיסמה עודכנה בהצלחה! מעביר לדף התחברות...";
                        message.style.color = "green";
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 2500);
                    }
                });
            }
        }
    </script>
</body>

</html>
