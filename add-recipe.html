<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <title>הוסף מתכון</title>
    <link rel="stylesheet" href="style3.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <form id="recipeForm" enctype="multipart/form-data">
        <h2>📝 הוסף מתכון חדש</h2>

        <label>כותרת המתכון:</label>
        <input type="text" name="title" required>

        <label>תיאור:</label>
        <textarea name="description" rows="4" required></textarea>

        <label>העלה עד 3 תמונות:</label>
        <input type="file" name="images" accept="image/*" multiple onchange="limitFiles(this)">
        <p id="fileLimitMessage" style="color: red; display: none; margin-top: 8px;">
            ❗ ניתן לבחור עד 3 תמונות בלבד.
        </p>

        <p>📨 הטופס ישלח לבדיקה ופרסום</p>

        <button type="button" id="userSubmitBtn">שלח</button>
    </form>

    <div id="secretBox" class="secret-box">
        <button class="close-btn" onclick="document.getElementById('secretBox').style.display='none'">✕</button>
        <p>הזן קוד מפתח:</p>
        <input type="password" id="secretCode" maxlength="8">
        <br><br>
        <button onclick="checkSecretCode()">אישור</button>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://izpbbjhikbbbyahxzhkg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cGJiamhpa2JiYnlhaHh6aGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTMxMDUsImV4cCI6MjA2Mzc2OTEwNX0.Gv0WaUlkUAW1qBNEaaXDCWWpwWgbvBTya8KQzFhx08s'; // שים את המפתח המלא שלך פה

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            },
            global: {
                headers: {
                    apikey: SUPABASE_KEY
                }
            }
        });


        // קוד מפתח Ctrl+M
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'm') {
                document.getElementById('secretBox').style.display = 'block';
            }
        });

        async function compressAndUploadImage(file, index) {
            return new Promise((resolve, reject) => {
                // 🛡 בדיקת פורמט קובץ
                const supportedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!supportedTypes.includes(file.type)) {
                    alert("⚠️ סוג הקובץ לא נתמך. השתמש ב־JPG / PNG / WEBP בלבד.");
                    return reject("פורמט לא נתמך: " + file.type);
                }

                console.log("📸 פורמט קובץ:", file.type);

                const reader = new FileReader();

                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;

                    img.onload = async function () {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height && width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        } else if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(async function (blob) {
                            if (!blob) {
                                alert("❌ לא ניתן לעבד את התמונה – נסה קובץ אחר");
                                return reject("blob is null");
                            }

                            const filename = `recipe_${Date.now()}_${index}.jpg`;
                            console.log("⬆️ מעלה קובץ בשם:", filename);

                            const { data, error } = await supabase.storage
                                .from('recipes-images')
                                .upload(filename, blob, {
                                    contentType: 'image/jpeg',
                                    upsert: false
                                });

                            if (error) {
                                console.error("❌ שגיאה בהעלאה:", error.message);
                                return reject(error);
                            }

                            const { data: urlData, error: publicUrlError } = supabase
                                .storage
                                .from('recipes-images')
                                .getPublicUrl(filename);

                            if (publicUrlError) {
                                console.error("❌ שגיאה בקבלת URL ציבורי:", publicUrlError.message);
                                return reject(publicUrlError);
                            }

                            console.log("✅ תמונה הועלתה:", urlData.publicUrl);
                            resolve(urlData.publicUrl);
                        }, 'image/jpeg', 0.7);
                    };

                    img.onerror = () => {
                        reject("שגיאה בטעינת התמונה");
                    };
                };

                reader.onerror = (err) => {
                    reject("שגיאה בקריאת הקובץ: " + err);
                };

                reader.readAsDataURL(file);
            });
        }
        document.getElementById("userSubmitBtn").addEventListener("click", async () => {
            const title = document.querySelector('input[name="title"]').value.trim();
            const description = document.querySelector('textarea[name="description"]').value.trim();
            const files = document.querySelector('input[type="file"]').files;

            if (!title || !description) {
                alert("יש למלא כותרת ותיאור");
                return;
            }

            // ❗ מניעה של יותר מ־3 תמונות
            if (files.length > 3) {
                alert("ניתן להעלות עד 3 תמונות בלבד.");
                return;
            }

            const imageUrls = [];
            for (let i = 0; i < files.length; i++) {
                try {
                    const url = await compressAndUploadImage(files[i], i);
                    imageUrls.push(url);
                } catch (error) {
                    alert("שגיאה בהעלאת תמונה #" + (i + 1));
                    return;
                }
            }

            const { error } = await supabase.from("recipes").insert({
                title,
                description,
                image1_url: imageUrls[0] || null,
                image2_url: imageUrls[1] || null,
                image3_url: imageUrls[2] || null,
                is_approved: false
            });

            if (error) {
                alert("שגיאה בשליחה: " + error.message);
            } else {
                window.location.href = "success-recipe.html";
            }
        });

        document.getElementById('userSubmitBtn').addEventListener('click', async () => {
            // ... פה נשאר false
        });

        window.limitFiles = function (input) {
            const msg = document.getElementById("fileLimitMessage");
            if (input.files.length > 3) {
                msg.style.display = "block";
                input.value = ""; // מנקה את הבחירה
            } else {
                msg.style.display = "none";
            }
        };

    </script>


</body>

</html>
